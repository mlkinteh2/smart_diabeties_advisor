{% extends 'dashboard/admin_base.html' %}
{% load static %}

{% block page_title %}User Management{% endblock %}
{% block page_subtitle %}Manage doctors and patients{% endblock %}

{% block extra_css %}
<style>
    /* User Management Specific Styles */
    .btn-add-user {
        background: var(--admin-purple);
        color: white;
        padding: 0.6rem 1.25rem;
        border-radius: 0.75rem;
        font-weight: 600;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        font-size: 0.875rem;
        box-shadow: 0 4px 6px -1px rgba(147, 51, 234, 0.2);
    }

    .btn-add-user:hover {
        background: var(--admin-purple-hover);
        color: white;
        transform: translateY(-2px);
    }

    /* Search and Filter Bar */
    .filter-bar {
        background: white;
        padding: 1rem;
        border-radius: 1rem;
        border: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .search-input-group {
        position: relative;
        flex-grow: 1;
    }

    .search-input {
        width: 100%;
        padding: 0.625rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        background: #f8fafc;
        font-size: 0.875rem;
        outline: none;
        transition: border-color 0.2s;
    }

    .search-input:focus {
        border-color: var(--admin-purple);
    }

    .filter-group {
        display: flex;
        background: #f1f5f9;
        padding: 0.25rem;
        border-radius: 0.75rem;
        gap: 0.25rem;
    }

    .filter-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.6rem;
        font-size: 0.8125rem;
        font-weight: 600;
        text-decoration: none;
        color: var(--text-muted);
        transition: all 0.2s;
        white-space: nowrap;
    }

    .filter-btn:hover {
        color: var(--text-main);
    }

    .filter-btn.active {
        background: var(--admin-purple);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(147, 51, 234, 0.2);
    }

    /* Users Table */
    .users-panel {
        background: white;
        border-radius: 1rem;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
    }

    .users-table th {
        text-align: left;
        padding: 0.75rem 1rem;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.025em;
        border-bottom: 1px solid var(--border-color);
    }

    .users-table td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        border-bottom: 1px solid var(--border-color);
    }

    .users-table tr:last-child td {
        border-bottom: none;
    }

    /* User Profile Cell */
    .user-cell {
        display: flex;
        align-items: center;
        gap: 0.875rem;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.75rem;
        flex-shrink: 0;
    }

    .user-info h4 {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--text-main);
        margin: 0;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .user-info p {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin: 0;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Badges */
    .role-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.625rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .role-badge.doctor {
        background: #fffbeb;
        color: #b45309;
        border: 1px solid #fef3c7;
    }

    .role-badge.patient {
        background: #f0fdf4;
        color: #15803d;
        border: 1px solid #dcfce7;
    }

    .status-badge {
        padding: 0.125rem 0.625rem;
        border-radius: 99px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-badge.active {
        background: #f0fdf4;
        color: #166534;
    }

    .status-badge.inactive {
        background: #fef2f2;
        color: #991b1b;
    }

    .activity-text {
        font-size: 0.8125rem;
        color: var(--text-main);
        font-weight: 500;
    }

    .activity-subtext {
        font-size: 0.6875rem;
        color: var(--text-muted);
        display: block;
    }

    .joined-date {
        font-size: 0.8125rem;
        color: var(--text-main);
    }

    /* Actions */
    .action-btns {
        display: flex;
        gap: 0.375rem;
        justify-content: flex-end;
    }

    .action-btn {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        color: var(--text-muted);
        transition: all 0.2s;
        text-decoration: none;
    }

    .action-btn:hover {
        background: #f1f5f9;
        color: var(--text-main);
    }

    .action-btn.delete:hover {
        background: #fee2e2;
        color: #ef4444;
    }

    /* Responsive Utilities */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .text-nowrap {
        white-space: nowrap !important;
    }
</style>
{% endblock %}

{% block header_actions %}
<a href="/admin/auth/user/add/" class="btn-add-user">
    <i class="bi bi-person-plus"></i>
    Add User
</a>
{% endblock %}

{% block dashboard_content %}
<div class="filter-bar">
    <div class="search-input-group">
        <form method="GET">
            <input type="text" name="search" class="search-input" placeholder="Search by name or email..."
                value="{{ search_query }}">
            <input type="hidden" name="role" value="{{ role_filter }}">
        </form>
    </div>
    <div class="filter-group">
        <a href="?role=all&search={{ search_query }}"
            class="filter-btn {% if role_filter == 'all' %}active{% endif %}">All Users</a>
        <a href="?role=doctors&search={{ search_query }}"
            class="filter-btn {% if role_filter == 'doctors' %}active{% endif %}">Doctors</a>
        <a href="?role=patients&search={{ search_query }}"
            class="filter-btn {% if role_filter == 'patients' %}active{% endif %}">Patients</a>
    </div>
</div>

<div class="users-panel">
    <div class="table-responsive">
        <table class="users-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Activity</th>
                    <th>Joined</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users_data %}
                <tr>
                    <td>
                        <div class="user-cell">
                            <div class="user-avatar"
                                style="background-color: {% cycle '#3b82f6' '#10b981' '#8b5cf6' '#f59e0b' '#ef4444' %};">
                                {{ u.initials }}
                            </div>
                            <div class="user-info">
                                <h4>{{ u.name }}</h4>
                                <p>{{ u.email }}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if u.role == 'Doctor' %}
                        <span class="role-badge doctor">
                            <i class="bi bi-stethoscope"></i> Doctor
                        </span>
                        {% elif u.role == 'Patient' %}
                        <span class="role-badge patient">
                            <i class="bi bi-person"></i> Patient
                        </span>
                        {% else %}
                        <span class="badge bg-secondary">{{ u.role }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge {{ u.status|lower }}">{{ u.status }}</span>
                    </td>
                    <td>
                        <span class="activity-text text-nowrap">{{ u.activity_main }}</span>
                        <span class="activity-subtext text-nowrap">{{ u.activity_sub }}</span>
                    </td>
                    <td>
                        <span class="joined-date text-nowrap">{{ u.joined|date:"Y-m-d" }}</span>
                    </td>
                    <td class="text-end">
                        <div class="action-btns">
                            <a href="#" class="action-btn" title="View Details">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="/admin/auth/user/{{ u.id }}/change/" class="action-btn" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{% url 'delete_user' u.id %}" class="action-btn delete" title="Delete">
                                <i class="bi bi-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <p class="text-muted">No users found matching your search.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}